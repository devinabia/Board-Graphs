<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMAC Voter Analytics</title>

    <!-- Dependencies -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --surface-0: #f9fafb;
            --surface-1: #ffffff;
            --surface-2: #f3f4f6;
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--surface-0);
            color: var(--text-primary);
        }

        .card {
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 1rem;
            transition: all 0.2s;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        /* Dropdown Styles */
        .dropdown-container {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            max-height: 250px;
            overflow-y: auto;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--surface-1) 0%,
                var(--surface-2) 50%,
                var(--surface-1) 100%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat Interface */
        .chat-container {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 320px;
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            z-index: 40;
            transition: all 0.3s ease;
            max-height: calc(100vh - 4rem);
        }

        .chat-container.collapsed {
            height: 60px;
            cursor: pointer;
        }

        .chat-container.expanded {
            height: 500px;
        }

        .chat-header {
            padding: 1rem;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .chat-messages {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-ai {
            background: var(--surface-2);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-right: 2rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .message-user {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-left: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            background: var(--surface-1);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .chat-input input {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .chat-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
            background: var(--surface-1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-2);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: var(--surface-0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }

        #loading-overlay .text-center {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface-2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.55, 0.25, 0.25, 0.7) infinite;
            box-shadow: var(--shadow-sm);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="text-center">
        <div class="spinner mb-4 mx-auto"></div>
        <p class="text-sm text-text-secondary text-center">Loading dashboard data...</p>
    </div>
</div>

<div class="min-h-screen p-3 sm:p-4 md:p-6 opacity-0 transition-opacity duration-300" id="dashboard-content">
    <!-- Header -->
    <header class="mb-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-6">
                <img src="public/assets/amac-logo.png" alt="AMAC Logo" class="h-16 w-auto" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));" />
                <div class="border-l border-gray-200 pl-6">
                    <h1 class="text-2xl font-bold">Voter Analytics</h1>
                    <p class="text-xs text-gray-400">Last updated: April 2024</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button class="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-primary transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Export
                </button>
            </div>
        </div>
    </header>
    <script>
        // 🔹 Global helpers (must be loaded first)
        function getKeyField(jurisdiction) {
          switch (jurisdiction) {
            case "Counties": return "JURISDICT_NM";
            case "Congressional Districts": return "NAMELSAD";
            case "Legislative Districts": return "NAMELSAD";
            case "Cities": return "CITY_NM";
            case "School Districts": return "LEAName";
            case "State Level": return "name";   // <-- WA.geojson "properties.name"
            default: return "JURISDICT_NM";
          }
        }

        let baseGeojsonCache = {};
        async function loadBaseGeojson(jurisdiction) {
          const fileMap = {
            "Counties": "/public/assets/WA_County_Boundaries.geojson",
            "Congressional Districts": "/public/assets/Congressional_District.geojson",
            "Legislative Districts": "/public/assets/wa_legislative_districts.geojson",
            "Cities": "/public/assets/CityLimits.geojson",
            "School Districts": "/public/assets/Washington_School_Districts_2024.geojson",
            "State Level": "/public/assets/washington.geojson"
          };
          const filePath = fileMap[jurisdiction];
          if (!filePath) return null;

          if (!baseGeojsonCache[jurisdiction]) {
            const res = await fetch(filePath);
            baseGeojsonCache[jurisdiction] = await res.json();
          }
          return baseGeojsonCache[jurisdiction];
        }

        function mergeDataWithGeojson(baseGeojson, data, keyField = "JURISDICT_NM") {
          const lookup = {};
          data.forEach((row) => {
            lookup[row.name.toLowerCase()] = row;
          });

          return {
            type: "FeatureCollection",
            features: baseGeojson.features.map((feat) => {
              const key = feat.properties[keyField]?.toLowerCase();
              const match = lookup[key];
              return {
                ...feat,
                properties: {
                  ...feat.properties,
                  name: feat.properties[keyField],
                  voter_count: match ? Number(match.voter_count) : 0,
                  turnout: match ? Number(match.turnout) : 0,
                },
              };
            }),
          };
        }
    </script>

    <script>
        let baseGeojson = null;

    async function loadBaseGeojson1() {
      if (!baseGeojson) {
        const res = await fetch("/public/assets/WA_County_Boundaries.geojson");
        baseGeojson = await res.json();
      }
      return baseGeojson;
    }

    let baseGeojsonCache2 = {};

    async function loadBaseGeojson2(jurisdiction) {
  const fileMap = {
    "Counties": "/public/assets/WA_County_Boundaries.geojson",
    "Congressional Districts": "/public/assets/Congressional_District.geojson",
    "Legislative Districts": "/public/assets/wa_legislative_districts.geojson",
    "Cities": "/public/assets/CityLimits.geojson",
    "School Districts": "/public/assets/Washington_School_Districts_2024.geojson",
    "State Level": "/public/assets/washington.geojson"
  };
  const filePath = fileMap[jurisdiction];
  if (!filePath) {
    console.warn(`No GeoJSON mapping for jurisdiction: ${jurisdiction}`);
    return null;
  }

  // ✅ Cache so we don’t reload every time
  if (!baseGeojsonCache[jurisdiction]) {
    const res = await fetch(filePath);
    baseGeojsonCache[jurisdiction] = await res.json();
  }

  return baseGeojsonCache[jurisdiction];
}

    function mergeDataWithGeojson(baseGeojson, data, keyField = "JURISDICT_NM") {
      const lookup = {};
      data.forEach((row) => {
        lookup[row.name.toLowerCase()] = row;
      });

      return {
        type: "FeatureCollection",
        features: baseGeojson.features.map((feat) => {
          const countyName = feat.properties[keyField]?.toLowerCase();
          const match = lookup[countyName];

          return {
            ...feat,
            properties: {
              ...feat.properties,
              name: feat.properties[keyField],  // ✅ ensure "name" always exists
              voter_count: match ? Number(match.voter_count) : 0,
              turnout: match ? Number(match.turnout) : 0,
            },
          };
        }),
      };
    }



    </script>
        <script>

      function jurisdictionDropdown() {
        return {
          open: false,
          selected: 'State Level',
          options: [
            'State Level',
            'Counties',
            'Legislative Districts',
            'Congressional Districts',
            'Cities',
            'School Districts'
          ],
          async updateView2() {
            const election = window.currentElection || 'Nov 2024';
            const jurisdiction = this.selected;

            const mapTitle = document.getElementById('map-title');
            if (mapTitle) {
              mapTitle.textContent = `Voter Distribution by ${jurisdiction}`;
            }

            try {
              const res = await fetch('/api/jurisdiction-map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ election, jurisdiction })
              });
              const { data } = await res.json();

              const base = await loadBaseGeojson(jurisdiction);
              const geojson = mergeDataWithGeojson(base, data, getKeyField(jurisdiction));
console.log(data)
              if (map.getSource('voter-data')) {
                map.getSource('voter-data').setData(geojson);
              } else {
                map.addSource('voter-data', { type: 'geojson', data: geojson });
                map.addLayer({
                  id: 'voter-choropleth',
                  type: 'fill',
                  source: 'voter-data',
                  paint: {
                        'fill-color': [
      'interpolate',
      ['linear'],
      ['get', 'voter_count'],
      0, '#e0f2ff',     // very light blue
      500, '#93c5fd',  // light-medium blue
      5000, '#3b82f6', // medium blue
      10000, '#1d4ed8', // dark blue
      30000, '#1e3a8a'  // very dark blue
    ],
                    'fill-opacity': 0.7,
                    'fill-outline-color': '#ffffff'
                  }
                });
              }
            } catch (err) {
              console.error("Failed to update jurisdiction map:", err);
            }
          }
        }
      }

            async function updateView() {
  const election = window.currentElection || 'Nov 2024';
  const jurisdiction = this.selected;

  // Update title above the map
  const mapTitle = document.getElementById('map-title');
  if (mapTitle) {
    mapTitle.textContent = `Voter Distribution by ${jurisdiction}`;
  }

  try {
    // Load stats from backend
    const res = await fetch('/api/jurisdiction-map', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ election, jurisdiction })
    });
    const { data } = await res.json();

    // Load shapefile
    const base = await loadBaseGeojson(jurisdiction);

    // Merge stats with shapefile
    const geojson = mergeDataWithGeojson(base, data, getKeyField(jurisdiction));

    // ✅ Only update data, not re-add source/layer
    if (map.getSource('voter-data')) {
      map.getSource('voter-data').setData(geojson);
    } else {
      // first time only
      map.addSource('voter-data', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'voter-choropleth',
        type: 'fill',
        source: 'voter-data',
        paint: {
          'fill-color': [
            'interpolate', ['linear'], ['get', 'voter_count'],
            0, '#e0f2ff',
            500, '#93c5fd',
            5000, '#3b82f6',
            10000, '#1d4ed8',
            30000, '#1e3a8a'
          ],
          'fill-opacity': 0.7,
          'fill-outline-color': '#ffffff'
        }
      });

      // ✅ Add hover layer only once
      map.addLayer({
        id: 'voter-choropleth-hover',
        type: 'line',
        source: 'voter-data',
        paint: { 'line-color': '#ffffff', 'line-width': 2 },
        filter: ['==', ['get', 'name'], null]
      });

      // ✅ Popup only once
      const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

      map.on('mousemove', 'voter-choropleth', (e) => {
        if (e.features.length > 0) {
          const f = e.features[0];
          map.setFilter('voter-choropleth-hover', ['==', ['get', 'name'], f.properties.name || null]);
          popup.setLngLat(e.lngLat)
            .setHTML(`
              <div class="p-2">
                <h4 class="font-medium">${f.properties.name || "Unknown"}</h4>
                <p class="text-sm">Registered Voters: ${Number(f.properties.voter_count || 0).toLocaleString()}</p>
                <p class="text-sm">Turnout: ${f.properties.turnout || 0}%</p>
              </div>
            `)
            .addTo(map);
        }
      });

      map.on('mouseleave', 'voter-choropleth', () => {
        map.setFilter('voter-choropleth-hover', ['==', ['get', 'name'], null]);
        popup.remove();
      });
    }
  } catch (err) {
    console.error("Failed to update jurisdiction map:", err);
  }
}

        </script>



    <!-- Filter Bar -->
    <div class="flex flex-col md:flex-row gap-3 mb-4">
        <!-- Election Period -->
        <div class="w-full md:flex-1 bg-white rounded-lg shadow-sm p-2">
            <h3 class="text-xs font-medium mb-1.5">Election Period</h3>
            <div class="dropdown-container" x-data="{
  open: false,
  selectedElection: 'Nov 2024',
  elections: ['Aug 2025', 'Nov 2024', 'Aug 2024', 'Nov 2023', 'Aug 2023', 'Feb 2024'],
  turnoutData: {
    'Aug 2025': 0,
    'Nov 2024': 76,
    'Aug 2024': 68,
    'Nov 2023': 72,
    'Aug 2023': 65,
    'Feb 2024': 58
  },
  updateElection(election) {
         this.selectedElection = election;
         window.currentElection = election;   // ✅ save globally
         refreshKPIs(election);
            const modeSelect = document.getElementById('jurisdiction-mode');
            if (modeSelect) {
            modeSelect.value = 'count';
            }

            renderJurisdictions(election, 'count');

    // ✅ Now this works
    document.querySelectorAll('.stat-value')[1].textContent = this.turnoutData[election] + '%';

  }
}">
                <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                    <div class="flex items-center gap-1.5">
                        <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                        <span class="text-sm text-gray-900 leading-none" x-text="selectedElection"></span>
                    </div>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0"></i>
                </button>
                <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                    <div class="py-1">
                        <template x-for="election in elections" :key="election">
                            <button
                                    type="button"
                                    @click="updateElection(election); open = false"
                                    :class="[
    'w-full text-left px-3 py-1.5 hover:bg-gray-50 text-sm',
    election === 'Nov 2024' || election === 'Aug 2024' ? 'font-bold text-primary' : ''
  ]"
                                    x-text="election">
                            </button>

                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jurisdiction Type -->
        <div class="flex-1 bg-white rounded-lg shadow-sm p-2">
            <h3 class="text-xs font-medium mb-1.5">Jurisdiction</h3>
            <div class="dropdown-container"
                 x-data="jurisdictionDropdown()"
                 x-init="updateView()">

                <!-- Button -->
                <button @click="open = !open"
                        class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
      <span class="text-sm text-gray-900 leading-none"
            x-text="selected || 'Select jurisdiction'">
        Select jurisdiction
      </span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0 ml-1.5"></i>
                </button>

                <!-- Dropdown menu -->
                <div x-show="open"
                     @click.away="open = false"
                     class="dropdown-menu mt-1 bg-white rounded shadow border border-gray-200 z-50">
                    <div class="py-1">
                        <template x-for="opt in options" :key="opt">
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                <input type="radio"
                                       name="jurisdiction"
                                       class="text-primary"
                                       :value="opt"
                                       x-model="selected"
                                       @change="open = false; updateView()">
                                <span class="text-sm text-gray-900" x-text="opt"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        <head>
            <!-- Alpine must see jurisdictionDropdown before rendering -->
            <script>
                function jurisdictionDropdown() {
                  return {
                    open: false,
                    selected: 'State Level',
                    options: [
                      'State Level',
                      'Counties',
                      'Legislative Districts',
                      'Congressional Districts',
                      'Cities',
                      'School Districts'
                    ],
                    async updateView() {
                      const election = window.currentElection || 'Nov 2024';
                      const jurisdiction = this.selected;

                      const mapTitle = document.getElementById('map-title');
                      if (mapTitle) {
                        mapTitle.textContent = `Voter Distribution by ${jurisdiction}`;
                      }

                      try {
                        const res = await fetch('/api/jurisdiction-map', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ election, jurisdiction })
                        });
                        const { data } = await res.json();

                        const base = await loadBaseGeojson(jurisdiction);
                        const geojson = mergeDataWithGeojson(base, data, getKeyField(jurisdiction));
console.log(data)
                        if (map.getSource('voter-data')) {
                          map.getSource('voter-data').setData(geojson);
                        } else {
                          map.addSource('voter-data', { type: 'geojson', data: geojson });
                          map.addLayer({
                            id: 'voter-choropleth',
                            type: 'fill',
                            source: 'voter-data',
                            paint: {
                              'fill-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'voter_count'],
                                0, '#e0f2ff',
                                5000, '#93c5fd',
                                15000, '#3b82f6',
                                25000, '#1d4ed8',
                                37000, '#1e3a8a'
                              ],
                              'fill-opacity': 0.7,
                              'fill-outline-color': '#ffffff'
                            }
                          });
                        }
                      } catch (err) {
                        console.error("Failed to update jurisdiction map:", err);
                      }
                    }
                  }
                }
            </script>



        <script>
            function jurisdictionDropdown1() {
              return {
                open: false,
                selected: 'State Level',
                options: [
                  'State Level',
                  'Counties',
                  'Legislative Districts',
                  'Congressional Districts',
                  'Cities',
                  'School Districts'
                ],
                async updateView1() {
                  const election = window.currentElection || 'Nov 2024';
                  const jurisdiction = this.selected;

                  // Update title above map
                  const mapTitle = document.getElementById('map-title');
                  if (mapTitle) {
                    mapTitle.textContent = `Voter Distribution by ${jurisdiction}`;
                  }

                 try {
  const res = await fetch('/api/jurisdiction-map', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ election, jurisdiction })
  });
  const { data } = await res.json();
   console.log(data)
  // load shapefile once
  const base = await loadBaseGeojson(jurisdiction);

  // merge stats with shapefile
  const geojson = mergeDataWithGeojson(base, data, "JURISDICT_NM");
if (window.map && window.map.getSource("voter-data")) {
  window.map.getSource("voter-data").setData(geojson);
} else if (window.map) {
  window.map.addSource("voter-data", { type: "geojson", data: geojson });
  window.map.addLayer({
    id: "voter-choropleth",
    type: "fill",
    source: "voter-data",
    paint: {
          'fill-color': [
      'interpolate',
      ['linear'],
      ['get', 'voter_count'],
      0, '#e0f2ff',     // very light blue
      500, '#93c5fd',  // light-medium blue
      5000, '#3b82f6', // medium blue
      10000, '#1d4ed8', // dark blue
      30000, '#1e3a8a'  // very dark blue
    ],
'fill-opacity': 0.7,
'fill-outline-color': '#ffffff'

    }
  });
}

} catch (err) {
  console.error('Failed to update jurisdiction map:', err);
}

                }
              }
            }


            async function updateView() {
  const election = window.currentElection || 'Nov 2024';
  const jurisdiction = this.selected;

  // Update map title
  const mapTitle = document.getElementById('map-title');
  if (mapTitle) {
    mapTitle.textContent = `Voter Distribution by ${jurisdiction}`;
  }

  try {
    // Load stats from backend
    const res = await fetch('/api/jurisdiction-map', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ election, jurisdiction })
    });
    const { data } = await res.json();

    // Load correct boundary GeoJSON
    const base = await loadBaseGeojson(jurisdiction);
console.log(data)
    // Merge DB stats into boundary features
    const geojson = mergeDataWithGeojson(base, data, getKeyField(jurisdiction));

    // Push into Mapbox
    if (map.getSource('voter-data')) {
      map.getSource('voter-data').setData(geojson);
    } else {
      map.addSource('voter-data', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'voter-choropleth',
        type: 'fill',
        source: 'voter-data',
        paint: {
          'fill-color': [
            'interpolate',
            ['linear'],
          ['get', 'voter_count'],
      0, '#e0f2ff',     // very light blue
      500, '#93c5fd',  // light-medium blue
      5000, '#3b82f6', // medium blue
      10000, '#1d4ed8', // dark blue
      30000, '#1e3a8a'  // very dark blue
    ],
          'fill-opacity': 0.7,
          'fill-outline-color': '#ffffff'
        }
      });
    }
  } catch (err) {
    console.error("Failed to update jurisdiction map:", err);
  }
}



        </script>


        <!-- Ethnicity Filter -->
        <div class="flex-1 bg-white rounded-lg shadow-sm p-2">
            <h3 class="text-xs font-medium mb-1.5">Ethnicity</h3>
            <div class="dropdown-container"
                 x-data="{
                        open: false,
                        selected: ['South Asian', 'Middle Eastern'],
                        updateView() {
                            const ethnicityData = {
                                'South Asian': 45,
                                'Middle Eastern': 30,
                                'African': 15,
                                'Southeast Asian': 10
                            };

                            // Calculate total for selected ethnicities
                            let total = 0;
                            this.selected.forEach(ethnicity => {
                                if (ethnicityData[ethnicity]) {
                                    total += ethnicityData[ethnicity];
                                }
                            });

                            // Update the donut chart
                            const ctx = document.getElementById('ethnicityChart').getContext('2d');

                            // Create new data for selected ethnicities
                            const chartData = {
                                labels: this.selected,
                                data: this.selected.map(e => ethnicityData[e])
                            };

                            // Update or create chart
                            if (window.ethnicityChart) {
                                window.ethnicityChart.data.labels = chartData.labels;
                                window.ethnicityChart.data.datasets[0].data = chartData.data;
                                window.ethnicityChart.update();
                            }
                        }
                    }"
                 @change="updateView">
                <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                    <span class="text-sm text-gray-900 leading-none" x-text="selected.length ? selected.join(', ') : 'Select ethnicities'">Select ethnicities</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0 ml-1.5"></i>
                </button>
                <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                    <div class="py-1">
                        <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="text-primary rounded" value="South Asian" x-model="selected">
                            <span class="text-sm text-gray-900">South Asian</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="text-primary rounded" value="Middle Eastern" x-model="selected">
                            <span class="text-sm text-gray-900">Middle Eastern</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="text-primary rounded" value="African" x-model="selected">
                            <span class="text-sm text-gray-900">African</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="text-primary rounded" value="Southeast Asian" x-model="selected">
                            <span class="text-sm text-gray-900">Southeast Asian</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 gap-6">
        <!-- Main Content -->
        <div class="space-y-6">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                <div class="card card-hover p-4">
                    <p class="text-text-secondary text-sm mb-1">Total Registered Voters</p>
                    <h3 class="text-2xl font-bold stat-value">247,890</h3>
                    <div class="flex items-center gap-1 mt-2 text-success text-sm">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        <span>12.4%</span>
                    </div>
                </div>
                <div class="card card-hover p-4">
                    <p class="text-text-secondary text-sm mb-1">Current Turnout</p>
                    <h3 class="text-2xl font-bold stat-value">76%</h3>
                    <div class="flex items-center gap-1 mt-2 text-success text-sm">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        <span>4.2%</span>
                    </div>
                </div>
                <div class="card card-hover p-4">
                    <p class="text-text-secondary text-sm mb-1">New Registrations</p>
                    <h3 class="text-2xl font-bold stat-value">1,245</h3>
                    <div class="flex items-center gap-1 mt-2 text-warning text-sm">
                        <i data-lucide="trending-down" class="w-4 h-4"></i>
                        <span>2.1%</span>
                    </div>
                </div>
                <div class="card card-hover p-4">
                    <p class="text-text-secondary text-sm mb-1">Active Districts</p>
                    <h3 class="text-2xl font-bold stat-value">42</h3>
                    <div class="mt-2 text-text-secondary text-sm">
                        <span>of 49 total</span>
                    </div>
                </div>
            </div>

            <!-- Map & Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Top Row: Map and Turnout -->
                <div class="lg:col-span-8 card" style="height: 400px">
                    <h3 id="map-title" class="absolute top-4 left-4 z-10 font-medium text-gray-900">Voter Distribution by State Level</h3>
                    <div id="map" class="w-full h-full rounded-lg"></div>
                </div>

                <div class="lg:col-span-4 card p-4">
                    <h3 class="font-medium mb-4">Turnout by Election</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="turnoutChart"></canvas>
                    </div>
                </div>

                <!-- Bottom Row: Jurisdiction and Ethnicity -->
                <div class="lg:col-span-8 card p-4" style="min-height: 300px; max-height: 400px; overflow-y: auto;">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sticky top-0 bg-surface-1 py-2">
                        <h3 class="font-medium mb-2 sm:mb-0">Top Jurisdictions</h3>
                        <select id="jurisdiction-mode" class="w-full sm:w-auto bg-surface-2 rounded px-2 py-1 text-sm">
                            <option value="count">By Voter Count</option>
                            <option value="turnout">By Turnout %</option>
                        </select>
                    </div>
                    <div  id="top-jurisdictions" class="space-y-4">

                    </div>
                </div>

                <div class="lg:col-span-4 card p-4">
                    <h3 class="font-medium mb-4">Ethnicity Distribution</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="ethnicityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Interface -->
<div class="chat-container"
     x-data="{
            expanded: false,
            messages: [],
            sendMessage(text) {
                if (text.trim()) {
                    this.messages.push({type: 'user', text: text});
                    setTimeout(() => {
                        this.messages.push({
                            type: 'ai',
                            text: 'Based on the voter data, ' + this.generateResponse(text)
                        });
                        this.$nextTick(() => {
                            document.getElementById('chat-messages').scrollTop =
                            document.getElementById('chat-messages').scrollHeight;
                        });
                    }, 300);
                }
            },
            generateResponse(question) {
                // Simple response generation based on keywords
                if (question.toLowerCase().includes('turnout')) {
                    return 'the voter turnout shows an increasing trend with 76% in November 2024 compared to 72% in November 2023.';
                } else if (question.toLowerCase().includes('district') || question.toLowerCase().includes('highest')) {
                    return 'King County has the highest number of eligible voters with 89,450 registered voters.';
                } else if (question.toLowerCase().includes('compare')) {
                    return 'comparing the last two elections, we see a 4.2% increase in voter turnout.';
                }
                return 'I can help you analyze specific trends in voter turnout, district comparisons, or election period data.';
            }
         }"
     :class="expanded ? 'expanded' : 'collapsed'">

    <div class="chat-header" @click="expanded = !expanded">
        <div class="flex items-center gap-2">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
            <span class="font-medium">Ask about the data</span>
        </div>
        <i data-lucide="chevron-up" class="w-5 h-5" x-show="expanded"></i>
        <i data-lucide="chevron-down" class="w-5 h-5" x-show="!expanded"></i>
    </div>

    <div x-show="expanded"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="chat-messages"
         id="chat-messages">

        <div class="chat-message">
            <div class="message-ai">
                Hi! I can help you analyze the voter data. Try asking questions like:
                <ul class="mt-2 ml-4 list-disc text-sm">
                    <li>What's the voter turnout trend?</li>
                    <li>Which district has the highest turnout?</li>
                    <li>Compare turnout between elections</li>
                </ul>
            </div>
        </div>

        <template x-for="message in messages">
            <div class="chat-message">
                <div :class="message.type === 'user' ? 'message-user' : 'message-ai'"
                     x-text="message.text">
                </div>
            </div>
        </template>
    </div>

    <div x-show="expanded"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="chat-input">
        <input type="text"
               placeholder="Ask a question about the data..."
               @keyup.enter="sendMessage($event.target.value); $event.target.value = ''">
        <button class="p-2 hover:bg-surface-2 rounded-lg"
                @click="const input = $el.previousElementSibling; sendMessage(input.value); input.value = ''"
                title="Send message">
            <i data-lucide="send" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<script>

    // Wait for Chart.js to load
    window.addEventListener('DOMContentLoaded', () => {
        // Initialize charts first
        initializeCharts();
        loadTurnoutSeries();
    });

    function initializeCharts() {
        // Initialize turnout chart

        // Initialize ethnicity chart
        const ethnicityCtx = document.getElementById('ethnicityChart');
        if (ethnicityCtx) {
            new Chart(ethnicityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['South Asian', 'Middle Eastern', 'African', 'Southeast Asian'],
                    datasets: [{
                        data: [45, 30, 15, 10],
                        backgroundColor: [
                            '#4361EE',  // South Asian (blue)
                            '#3A0CA3',  // Middle Eastern (deep purple)
                            '#7209B7',  // African (medium purple)
                            '#B5179E'   // Southeast Asian (light purple)
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                color: '#4b5563',
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                },
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            titleFont: {
                                family: "'Inter', sans-serif",
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                family: "'Inter', sans-serif",
                                size: 13
                            },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }
    }

    // Simulate loading state
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('loading-overlay').style.opacity = '0';
            document.getElementById('dashboard-content').style.opacity = '1';
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
            }, 300);
        }, 1000);
    });

    // Initialize Lucide icons
    lucide.createIcons();

    // Initialize Mapbox
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FqYS1yIiwiYSI6ImNtZXRjaHhiajAwcjgya3B5cjJqaDljZGwifQ.o1uEOA7pV2RB_0A8jicwqg';

    try {
        window.map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-120.740135, 47.751076],
            zoom: 6,
            pitch: 45,
            bearing: -17.6,
            antialias: true
        });

        // Sample GeoJSON data for Washington counties
        const sampleData = {
            'type': 'FeatureCollection',
            'features': [
                {
                    'type': 'Feature',
                    'properties': {
                        'name': 'King County',
                        'voter_count': 89450,
                        'turnout': 76
                    },
                    'geometry': {
                        'type': 'Polygon',
                        'coordinates': [[[-122.5, 47.4], [-122.5, 47.8], [-121.8, 47.8], [-121.8, 47.4], [-122.5, 47.4]]]
                    }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'name': 'Pierce County',
                        'voter_count': 45230,
                        'turnout': 72
                    },
                    'geometry': {
                        'type': 'Polygon',
                        'coordinates': [[[-122.8, 47.0], [-122.8, 47.4], [-122.1, 47.4], [-122.1, 47.0], [-122.8, 47.0]]]
                    }
                }
            ]
        };

        map.on('load', () => {
            // Add the data source
            console.log(sampleData)
            map.addSource('voter-data', {
                'type': 'geojson',
                'data': sampleData
            });

            // Add choropleth layer
            map.addLayer({
                'id': 'voter-choropleth',
                'type': 'fill',
                'source': 'voter-data',
                'paint': {
                       'fill-color': [
      'interpolate',
      ['linear'],
      ['get', 'voter_count'],
      0, '#e0f2ff',     // very light blue
      500, '#93c5fd',  // light-medium blue
      5000, '#3b82f6', // medium blue
      10000, '#1d4ed8', // dark blue
      30000, '#1e3a8a'  // very dark blue
    ],
'fill-opacity': 0.7,
'fill-outline-color': '#ffffff'

                }
            });

            // Add hover effect
            map.addLayer({
                'id': 'voter-choropleth-hover',
                'type': 'line',
                'source': 'voter-data',
                'paint': {
                    'line-color': '#ffffff',
                    'line-width': 2
                },
                'filter': ['==', ['get', 'name'], null]
            });
            map.on('mousemove', 'voter-choropleth', (e) => {
  if (e.features.length > 0) {
    const feature = e.features[0];

    // ✅ safe update
   map.setFilter(
  'voter-choropleth-hover',
  ['==', ['get', 'name'], feature?.properties?.name ?? null]
);
    popup.setLngLat(e.lngLat)
      .setHTML(`
        <div class="p-2">
          <h4 class="font-medium">${feature.properties.name || 'Unknown'}</h4>
          <p class="text-sm">Registered Voters: ${feature.properties.voter_count?.toLocaleString() || 0}</p>
          <p class="text-sm">Turnout: ${feature.properties.turnout || 0}%</p>
        </div>
      `)
      .addTo(map);
  }
});

map.on('mouseleave', 'voter-choropleth', () => {
  map.setFilter('voter-choropleth-hover', ['==', ['get', 'name'], null]);  // ✅ reset with null
  popup.remove();
});


            // Add popup on hover
            const popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });

            map.on('mousemove', 'voter-choropleth', (e) => {
                if (e.features.length > 0) {
                    const feature = e.features[0];

                    // Update hover effect
map.setFilter(
  'voter-choropleth-hover',
  ['==', ['get', 'name'], feature?.properties?.name ?? null]
);
                    // Show popup
                    popup.setLngLat(e.lngLat)
                        .setHTML(`
                            <div class="p-2">
                                <h4 class="font-medium">${feature.properties.name}</h4>
                                <p class="text-sm">Registered Voters: ${feature.properties.voter_count.toLocaleString()}</p>
                                <p class="text-sm">Turnout: ${feature.properties.turnout}%</p>
                            </div>
                        `)
                        .addTo(map);
                }
            });

            map.on('mouseleave', 'voter-choropleth', () => {
                map.setFilter('voter-choropleth-hover', ['==', ['get', 'name'], '']);
                popup.remove();
            });

            // Add 3D building layer for better visualization
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 12,
                'paint': {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            });
        });

        map.on('error', (e) => {
            console.error('Map error:', e);
            document.getElementById('map').innerHTML = `
                <div class="flex items-center justify-center h-full bg-surface-2 rounded-lg">
                    <div class="text-center p-4">
                        <i data-lucide="map-off" class="w-8 h-8 mx-auto mb-2 text-text-secondary"></i>
                        <p class="text-text-secondary">Map loading error. Please check your connection.</p>
                    </div>
                </div>
            `;
        });
    } catch (error) {
        console.error('Map initialization error:', error);
        document.getElementById('map').innerHTML = `
            <div class="flex items-center justify-center h-full bg-surface-2 rounded-lg">
                <div class="text-center p-4">
                    <i data-lucide="map-off" class="w-8 h-8 mx-auto mb-2 text-text-secondary"></i>
                    <p class="text-text-secondary">Unable to load map. Please check your API key.</p>
                </div>
            </div>
        `;
    }

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());

    // Initialize Charts
    // Date range picker modal
    const dateRangeModal = document.createElement('div');
    dateRangeModal.innerHTML = `
        <div id="dateRangePicker" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-96">
                <h3 class="text-lg font-semibold mb-4">Select Date Range</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="closeDateRangePicker()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md">Cancel</button>
                        <button onclick="applyDateRange()" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-md">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(dateRangeModal);


    const ethnicityCtx = document.getElementById('ethnicityChart').getContext('2d');
    new Chart(ethnicityCtx, {
        type: 'doughnut',
        data: {
            labels: ['South Asian', 'Middle Eastern', 'African', 'Southeast Asian'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: [
                    '#2563eb',  // Primary blue
                    '#7c3aed',  // Purple
                    '#9333ea',  // Violet
                    '#c084fc'   // Light purple
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    align: 'center',
                    labels: {
                        color: '#4b5563',
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            family: "'Inter', sans-serif",
                            size: 12
                        },
                        boxWidth: 8
                    }
                },
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleFont: {
                        family: "'Inter', sans-serif",
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        family: "'Inter', sans-serif",
                        size: 13
                    },
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            },
            cutout: '70%'
        }
    });

    // Filter functions
    function filterLastElection() {
        // Update chart data for the most recent election (November 2024)
        turnoutChart.data.labels = ['Nov 24'];
        turnoutChart.data.datasets[0].data = [76];
        turnoutChart.update();

        // Update KPI cards
        document.querySelector('.stat-value').textContent = '76%';
        document.querySelector('.text-success').innerHTML = `
            <i data-lucide="trending-up" class="w-4 h-4"></i>
            <span>4.2%</span>
        `;

        // Update jurisdiction data
        const topJurisdictions = document.querySelector('.top-jurisdictions');
        if (topJurisdictions) {
            // Update with November 2024 data
            topJurisdictions.innerHTML = `
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">King County</span>
                        <span class="stat-value">89,450</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: 100%"></div>
                    </div>
                </div>
            `;
        }

        // Update active button state
        document.querySelectorAll('header button').forEach(btn => {
            btn.classList.remove('text-primary');
            if (btn.textContent.includes('Last Election')) {
                btn.classList.add('text-primary');
            }
        });

        lucide.createIcons();
    }

    function showDateRangePicker() {
        document.getElementById('dateRangePicker').classList.remove('hidden');
    }

    function closeDateRangePicker() {
        document.getElementById('dateRangePicker').classList.add('hidden');
    }

    function applyDateRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        // Format dates for display
        const formattedStartDate = new Date(startDate).toLocaleDateString();
        const formattedEndDate = new Date(endDate).toLocaleDateString();

        // Update the displayed date range
        const dateRangeElement = document.querySelector('[x-data*="dateRange"]');
        if (dateRangeElement) {
            const alpineData = Alpine.raw(dateRangeElement.__x.$data);
            alpineData.dateRange = `${formattedStartDate} - ${formattedEndDate}`;
            alpineData.open = false;
        }

        // Update chart with filtered data
        const filteredData = filterDataByDateRange(startDate, endDate);
        turnoutChart.data.labels = filteredData.labels;
        turnoutChart.data.datasets[0].data = filteredData.data;
        turnoutChart.update();
    }

    function filterDataByDateRange(startDate, endDate) {
        // This is a placeholder function - in reality, you would fetch data from your backend
        const allData = {
            labels: ['Aug 23', 'Nov 23', 'Aug 24', 'Nov 24'],
            data: [65, 72, 68, 76]
        };

        // Filter data based on date range
        // This is simplified - you should use proper date comparison
        return allData;
    }

    // Cache common filter combinations
    const cachedFilters = {
        'last-election': {
            period: 'November 2024',
            jurisdiction: 'County',
            ethnicity: 'All'
        }
    };

    // Handle filter changes
    document.querySelectorAll('input[type="checkbox"], button').forEach(element => {
        element.addEventListener('click', () => {
            // Simulate loading state for filter changes
            const overlay = document.createElement('div');
            overlay.className = 'absolute inset-0 bg-surface-0 bg-opacity-50 flex items-center justify-center';
            overlay.innerHTML = '<div class="spinner"></div>';

            setTimeout(() => {
                overlay.remove();
            }, 500);
        });
    });
</script>

<script>
    async function refreshKPIs1(election) {
   const statValues = document.querySelectorAll('.stat-value');
   const totalVotersEl = statValues[0];
   const turnoutEl = statValues[1];
   const newRegsEl = statValues[2];
   const activeDistrictsEl = statValues[3];

   // Reset to 0 first
   totalVotersEl.textContent = "0";
   turnoutEl.textContent = "0%";
   newRegsEl.textContent = "0";
   activeDistrictsEl.textContent = "0";

   if (election === "Nov 2024" || election === "Aug 2024") {
     try {
       const res = await fetch("/api/election-metrics", {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify({ election })
       });
       const data = await res.json();

       // ✅ Use row object
       const row = data.row || {};

       totalVotersEl.textContent = row.total_voters?.toLocaleString() || "0";
       turnoutEl.textContent = (row.turnout_pct || 0) + "%";
       newRegsEl.textContent = row.new_regs?.toLocaleString() || "0";
       activeDistrictsEl.textContent = row.active_legis || "0";
     } catch (err) {
       console.error("Failed to fetch election metrics:", err);
     }
   }
 }

 async function refreshKPIs2(election, mode = "count") {
  // KPI Cards
  const statValues = document.querySelectorAll('.stat-value');
  const totalVotersEl = statValues[0];
  const turnoutEl = statValues[1];
  const newRegsEl = statValues[2];
  const activeDistrictsEl = statValues[3];

  // reset first
  totalVotersEl.textContent = "0";
  turnoutEl.textContent = "0%";
  newRegsEl.textContent = "0";
  activeDistrictsEl.textContent = "0";

  // ✅ KPIs
  if (election === "Nov 2024" || election === "Aug 2024") {
    try {
      const res = await fetch("/api/election-metrics", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ election })
      });
      const data = await res.json();

      totalVotersEl.textContent = data.row?.total_voters?.toLocaleString() || "0";
      turnoutEl.textContent = (data.row?.turnout_pct || 0) + "%";
      newRegsEl.textContent = data.row?.new_regs?.toLocaleString() || "0";
      activeDistrictsEl.textContent = data.row?.active_legis || "0";
    } catch (err) {
      console.error("Failed to fetch election metrics:", err);
    }
  }

  //  Top Jurisdictions
  try {
    const res = await fetch(`/api/top-jurisdictions?election=${encodeURIComponent(election)}&mode=${mode}`);
    const jurisdictions = await res.json();
    console.log(jurisdictions)
    const container = document.querySelector("#top-jurisdictions");
    if (container && jurisdictions) {
      container.innerHTML = `
        <div class="flex flex-col sm:flex-row justify-between mb-2">
          <span class="font-medium">County – ${jurisdictions.county.name}</span>
          <span class="stat-value">${jurisdictions.county.value.toLocaleString()}</span>
        </div>
        <div class="progress-bar"><div class="progress-bar-fill" style="width:100%"></div></div>

        <div class="flex flex-col sm:flex-row justify-between mb-2">
          <span class="font-medium">Congressional District – ${jurisdictions.congressional.name}</span>
          <span class="stat-value">${jurisdictions.congressional.value.toLocaleString()}</span>
        </div>
        <div class="progress-bar"><div class="progress-bar-fill" style="width:80%"></div></div>

        <div class="flex flex-col sm:flex-row justify-between mb-2">
          <span class="font-medium">Legislative District – ${jurisdictions.legislative.name}</span>
          <span class="stat-value">${jurisdictions.legislative.value.toLocaleString()}</span>
        </div>
        <div class="progress-bar"><div class="progress-bar-fill" style="width:60%"></div></div>

        ${jurisdictions.cities.map(city => `
          <div class="flex flex-col sm:flex-row justify-between mb-2">
            <span class="font-medium">${city.name}</span>
            <span class="stat-value">${city.value.toLocaleString()}</span>
          </div>
          <div class="progress-bar"><div class="progress-bar-fill" style="width:50%"></div></div>
        `).join("")}
      `;
    }
  } catch (err) {
    console.error("Failed to fetch jurisdictions:", err);
  }
}

// Global cache
window.jurisdictionCache = {};

async function refreshKPIs(election) {
  // KPI Cards
  const statValues = document.querySelectorAll('.stat-value');
  const totalVotersEl = statValues[0];
  const turnoutEl = statValues[1];
  const newRegsEl = statValues[2];
  const activeDistrictsEl = statValues[3];

  // reset KPIs
  totalVotersEl.textContent = "0";
  turnoutEl.textContent = "0%";
  newRegsEl.textContent = "0";
  activeDistrictsEl.textContent = "0";

  // ✅ Election KPIs
  if (election === "Nov 2024" || election === "Aug 2024") {
    try {
      const res = await fetch("/api/election-metrics", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ election })
      });
      const data = await res.json();

      totalVotersEl.textContent = data.row?.total_voters?.toLocaleString() || "0";
      turnoutEl.textContent = (data.row?.turnout_pct || 0) + "%";
      newRegsEl.textContent = data.row?.new_regs?.toLocaleString() || "0";
      activeDistrictsEl.textContent = data.row?.active_legis || "0";
    } catch (err) {
      console.error("Failed to fetch election metrics:", err);
    }
  }
 const modeSelect = document.querySelector("#jurisdiction-mode");
  if (modeSelect) modeSelect.value = "count";

  // ✅ Top Jurisdictions (fetch once per election, store both count + turnout)
  try {
    const res = await fetch("/api/top-jurisdictions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ election })
    });

    const jurisdictions = await res.json();

    // store in cache
    window.jurisdictionCache[election] = jurisdictions;
    console.log(window.jurisdictionCache[election])
    // render default → count
    renderJurisdictions(election, "count");
  } catch (err) {
    console.error("Failed to fetch jurisdictions:", err);
  }
}




     // ✅ Run once on load with default "Nov 2024"
window.addEventListener("DOMContentLoaded", () => {
  // Load default metrics
  window.currentElection = "Nov 2024";
  refreshKPIs("Nov 2024");

  // Attach mode change listener once
  const modeSelect = document.getElementById("jurisdiction-mode");
  if (modeSelect) {
    modeSelect.addEventListener("change", (e) => {
      const mode = e.target.value; // "count" or "turnout"
      const election = window.currentElection || "Nov 2024";
      renderJurisdictions(election, mode);
    });
  }
});


    function renderJurisdictions(election, mode = "count") {
    console.log(election)
  const jurisdictions = window.jurisdictionCache[election];
  if (!jurisdictions) return;

  const container = document.querySelector("#top-jurisdictions");
  if (!container) return;

  function formatValue(item) {
    return mode === "count"
      ? (item.count || 0).toLocaleString()
      : (item.turnout || 0) + "%";
  }

  function percentWidth(item, maxValue) {
    return mode === "count"
      ? Math.round((item.count / maxValue) * 100)
      : item.turnout;
  }

  // Build items array from the new data structure
  const items = [];
  
  // Add county
  if (jurisdictions.county) {
    items.push({ label: "County", ...jurisdictions.county });
  }
  
  // Add congressional district
  if (jurisdictions.congressional) {
    items.push({ label: "Congressional District", ...jurisdictions.congressional });
  }
  
  // Add legislative district
  if (jurisdictions.legislative) {
    items.push({ label: "Legislative District", ...jurisdictions.legislative });
  }
  
  // Add cities (array of city objects)
  if (jurisdictions.cities && Array.isArray(jurisdictions.cities)) {
    jurisdictions.cities.forEach(city => {
      items.push({ label: "City", ...city });
    });
  }

  const maxValue =
    mode === "count" ? Math.max(...items.map(i => i.count || 0)) : 100;

  container.innerHTML = items.map(i => `
    <div class="flex flex-col sm:flex-row justify-between mb-2">
      <span class="font-medium">${i.label ? i.label + " – " : ""}${i.name}</span>
      <span class="stat-value">${formatValue(i)}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-bar-fill" style="width:${percentWidth(i, maxValue)}%"></div>
    </div>
  `).join("");
}

</script>


<script>
    async function loadTurnoutSeries() {
   try {
     const res = await fetch("/api/turnout-series");
     if (!res.ok) throw new Error(`HTTP ${res.status}`);
     const { labels, data } = await res.json();

     const turnoutCtx = document.getElementById("turnoutChart").getContext("2d");

     // 🔹 Destroy only if it's a Chart instance
     if (window.turnoutChart && typeof window.turnoutChart.destroy === "function") {
       window.turnoutChart.destroy();
     }

     // 🔹 Create a new Chart instance
     window.turnoutChart = new Chart(turnoutCtx, {
       type: "bar",
       data: {
         labels,
         datasets: [
           {
             data,
             backgroundColor: labels.map((l) =>
               l === "Nov 2024" || l === "Aug 2024" ? "#1d4ed8" : "#2563eb"
             ),
             borderRadius: { topLeft: 4, topRight: 4 },
             barThickness: 40,
             hoverBackgroundColor: "#1d4ed8",
           },
         ],
       },
       options: {
         responsive: true,
         maintainAspectRatio: false,
         plugins: { legend: { display: false } },
         scales: {
           y: {
             beginAtZero: true,
             max: 100,
             ticks: {
               callback: (v) => v + "%",
             },
           },
         },
       },
     });
   } catch (err) {
     console.error("Failed to load turnout series:", err);
   }
 }



  // Call on load
  window.addEventListener("DOMContentLoaded", loadTurnoutSeries);




</script>
<script>
    async function loadJurisdictionMap2(election, jurisdiction) {
  try {
    const res = await fetch("/api/jurisdiction-map", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ election, jurisdiction }),
    });

    const { data } = await res.json();
console.log(data)
    // Convert into GeoJSON (⚠️ You’ll eventually replace sample polygons with real shapefiles)
    const geojson = {
      type: "FeatureCollection",
      features: data.map((row) => ({
        type: "Feature",
        properties: {
          name: row.name,
          voter_count: Number(row.voter_count), // ✅ ensure numeric
      turnout: Number(row.turnout)
        },
        geometry: {
          type: "Polygon",
          coordinates: [[]], // TODO: insert real geometry (GeoJSON from shapefiles or TIGER data)
        },
      })),
    };

    // Update map source dynamically
   if (window.map && window.map.getSource("voter-data")) {
  window.map.getSource("voter-data").setData(geojson);
} else if (window.map) {
  window.map.addSource("voter-data", { type: "geojson", data: geojson });
  window.map.addLayer({
    id: "voter-choropleth",
    type: "fill",
    source: "voter-data",
    paint: {
            'fill-color': [
      'interpolate',
      ['linear'],
      ['get', 'voter_count'],
      0, '#e0f2ff',     // very light blue
      500, '#93c5fd',  // light-medium blue
      5000, '#3b82f6', // medium blue
      10000, '#1d4ed8', // dark blue
      30000, '#1e3a8a'  // very dark blue
    ],
'fill-opacity': 0.7,
'fill-outline-color': '#ffffff'

}
  });
}

  } catch (err) {
    console.error("Failed to load jurisdiction map:", err);
  }
}

</script>


</body>
</html>